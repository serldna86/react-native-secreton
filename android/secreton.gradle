/**
 * =========================
 * Secreton bootstrap
 * =========================
 */

ext.findWorkspaceRoot = { File startDir ->
    File current = startDir
    while (current != null) {
        if (new File(current, "package.json").exists()) {
            return current
        }
        current = current.parentFile
    }
    throw new RuntimeException("‚ùå package.json not found")
}

ext.loadEnvFile = { File file ->
    if (!file.exists()) return [:]

    def map = [:]
    file.eachLine { line ->
        line = line.trim()
        if (!line || line.startsWith("#")) return

        def idx = line.indexOf("=")
        if (idx <= 0) return

        def key = line.substring(0, idx)
        def value = line.substring(idx + 1)

        if (value.startsWith("\"") && value.endsWith("\"")) {
            value = value.substring(1, value.length() - 1)
        }

        map[key] = value
    }
    return map
}

ext.ensureLocalEnv = { appProject ->
    if (appProject.ext.has("localEnv")) return

    appProject.ext.localEnv = [:]
    appProject.ext.env = [:]

    def androidDir = appProject.rootProject.projectDir
    def workspaceRoot = findWorkspaceRoot(androidDir)
    def rootDir = workspaceRoot

    def envFileName = appProject.findProperty("ENVFILE") ?: System.getenv("ENVFILE") ?: ".env"
    def envFile = new File(rootDir, envFileName)

    if (envFile.exists()) {
        appProject.ext.localEnv.putAll(loadEnvFile(envFile))
    }
}

ext.getSecretKey = { appProject ->
    ensureLocalEnv(appProject)
    return appProject.ext.localEnv.get("ENV_SECRET_KEY")
        ?: appProject.findProperty("ENV_SECRET_KEY")
        ?: System.getenv("ENV_SECRET_KEY")
}

ext.decryptValue = { String encrypted, String secretKey ->
    if (!encrypted) return encrypted
    if (!secretKey) throw new RuntimeException("‚ùå ENV_SECRET_KEY is required for decryption")

    def cmd = """printf "%s" '${encrypted}' | openssl enc -aes-256-cbc -a -A -d -salt -pbkdf2 -iter 100000 -pass pass:${secretKey}"""
    def proc = ["bash", "-c", cmd].execute()
    proc.waitFor()

    if (proc.exitValue() != 0) {
        throw new RuntimeException(proc.err.text)
    }

    return proc.in.text.trim()
}

ext.loadAndDecryptEnv = { appProject ->
    ensureLocalEnv(appProject)

    def androidDir = appProject.rootProject.projectDir
    def rootDir = findWorkspaceRoot(androidDir)

    def envFileName =
        appProject.findProperty("ENVFILE")
        ?: System.getenv("ENVFILE")
        ?: ".env"
    def envFile = new File(rootDir, envFileName)
    if (!envFile.exists()) return

    def secretKey = getSecretKey(appProject)
    if (!secretKey) return

    def envMap = loadEnvFile(envFile)
    envMap.each { k, v ->
        def value = v
        if (v instanceof String && v.startsWith("enc:")) {
            value = decryptValue(v.substring(4), secretKey)
        }
        appProject.ext.env[k] = value
    }
}

ext.findRnSecretonCli = { appProject ->
    def androidDir = appProject.rootProject.rootDir
    def workspaceRoot = findWorkspaceRoot(androidDir)
    def possibleCliBins = [
        new File(workspaceRoot, "node_modules/.bin/rn-secreton-cli"),
        new File(workspaceRoot.parentFile, "node_modules/.bin/rn-secreton-cli"),
        new File(workspaceRoot, "node_modules/.bin/rn-secreton-cli.cmd"),
        new File(workspaceRoot.parentFile, "node_modules/.bin/rn-secreton-cli.cmd")
    ].collect { it.canonicalFile }
    
    def cliBin = possibleCliBins.find { it.exists() }
    if (!cliBin) {
        throw new RuntimeException("‚ùå rn-secreton-cli not found in expected paths: ${possibleCliBins*.absolutePath}")
    }
    return cliBin
}

ext.loadEnvFromSecretonCliSync = { appProject ->
    def cliBin = findRnSecretonCli(appProject)
    def workspaceRoot = findWorkspaceRoot(appProject.rootProject.rootDir)
    def envFileName = appProject.findProperty("ENVFILE") ?: System.getenv("ENVFILE") ?: ".env"
    def envFile = new File(workspaceRoot, envFileName)

    ensureLocalEnv(appProject)
    def secretKey = getSecretKey(appProject)
    if (!secretKey) throw new RuntimeException("‚ùå ENV_SECRET_KEY not found")
    if (!envFile.exists()) throw new RuntimeException("‚ùå ENV file not found: ${envFile.absolutePath}")

    println "üîê rn-secreton generating env (sync)..."
    println "   ENV_FILE : ${envFileName}"
    println "   CLI path : ${cliBin.absolutePath}"

    def envMap = loadEnvFile(envFile)
    def envFromFile = envMap.collect { k, v -> "${k}=${v}" }
    def envArray = [
        "ENV_SECRET_KEY=${secretKey}",
        "ENV_FILE=${envFileName}",
        "PATH=${System.getenv("PATH")}"
    ]
    envArray += envFromFile
    envArray = envArray as String[]

    def proc = [cliBin.absolutePath, envFile.absolutePath].execute(envArray, workspaceRoot)
    proc.waitForProcessOutput(System.out, System.err)
    if (proc.exitValue() != 0) {
        throw new RuntimeException("‚ùå rn-secreton-cli failed")
    }

    loadAndDecryptEnv(appProject)
}
